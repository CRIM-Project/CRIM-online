/*! meiview 2014-09-02 */
"undefined"!=typeof Vex&&(Vex.Flow.STAVE_LINE_THICKNESS=1),meiView={},meiView.VarTypeList={reconstruction:{title:"editor",attr:"resp",el:"rdg",parent:"app"},concordance:{title:'source[type="concordance"]',attr:"source",el:"rdg",parent:"app"},blank:{title:null,attr:null,el:"rdg",parent:"app"}},meiView.Util={},meiView.Util.loadXMLDoc=function(a){if(xmlhttp=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),xmlhttp.open("GET",a,!1),xmlhttp.send(),!xmlhttp.responseXML)throw a+" cannot be loaded.";return xmlhttp.responseXML},meiView.SelectedSuppliedPartList=function(a){this.init(a)},meiView.SelectedSuppliedPartList.prototype.init=function(a){this.origins={},this.var_type=a},meiView.SelectedSuppliedPartList.prototype.toggleSuppliedPart=function(a){this.origins[a]=!this.origins[a]},meiView.SelectedSuppliedPartList.prototype.originsList=function(){var a=[];return $.each(this.origins,function(b,c){c&&a.push(b)}),a},meiView.Viewer=function(a){this.init(a)},meiView.DISPLAY_MEASURE_NUMBERS={NONE:0,ALL:1},meiView.Viewer.prototype.init=function(a){var b=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-8)};this.id=a.id||b(),this.MEI=a.MEI,this.MEI.initSectionView(),this.display_measure_numbers=a.display_measure_numbers,a.pages?this.pages=a.pages:(this.pages=new meiView.Pages,this.parsePages&&this.parsePages(this.MEI)),this.scoreWidth=a.width||1200,this.scoreHeight=a.height||1e3,this.createSourceList(this.MEI.ALTs),this.SuppliedPartLists={};for(var c in meiView.VarTypeList)this.SuppliedPartLists[c]=this.createSuppliedPartList(c);this.selectedSuppliedPartLists={};for(var c in meiView.VarTypeList)this.selectedSuppliedPartLists[c]=new meiView.SelectedSuppliedPartList(c);this_viewer=this,this.UI=new meiView.UI({viewer:this_viewer,maindiv:a.maindiv,title:a.title})},meiView.Viewer.prototype.toggleSuppliedPart=function(a,b){this.selectedSuppliedPartLists[a].toggleSuppliedPart(b),this.selectSuppliedParts()},meiView.Viewer.prototype.createSuppliedPartList=function(a){var b=meiView.VarTypeList[a].title,c=meiView.VarTypeList[a].attr,d=meiView.VarTypeList[a].el,e={},f=this;if(c){var g=$(this.MEI.rich_head).find("fileDesc").find(b);$(g).each(function(){var a=$(this).attr("xml:id");if(!a)throw"Origin ID is undefined";$(f.MEI.rich_score).find(d+"["+c+'="#'+a+'"]').length>0&&(e[a]=this)})}else $(f.MEI.rich_score).find(d+'[type="'+a+'"]').length>0&&(e[a]=a);return e},meiView.Viewer.prototype.createSourceList=function(a){this.Sources={},this.Emendations={},this.Report={};for(appID in a){var b=a[appID],c=$($(b.elem).closest("measure")[0]).attr("n");("choice"===b.tagname||"app"===b.tagname&&"reconstruction"!==$(b.elem).attr("type")&&"concordance"!==$(b.elem).attr("type"))&&("undefined"==typeof this.Report[c]&&(this.Report[c]=[]),this.Report[c].push(a[appID]));var d;"app"===b.tagname?d=this.Sources:"choice"===b.tagname&&(d=this.Emendations);for(varXMLID in b.altitems){var e=b.altitems[varXMLID],f=e.tagname;if("rdg"===f&&"concordance"!==$(e.elem).attr("type")||"corr"===f){var g;if(g="rdg"===f?e.source:e.resp)for(var h=g.split(" "),i=0;i<h.length;i++){var j=h[i];d[j]||(d[j]=[]),d[j].push({appID:b.xmlID,measureNo:c})}}else("lem"===f||"sic"===f)&&(d[f]||(d[f]=[]),d[f].push({appID:b.xmlID,measureNo:c}))}}},meiView.Viewer.prototype.selectingState={enter:function(a,b){this.ON=!0,this.appID=a,this.selectedVarXmlID=b},select:function(a){this.selectedVarXmlID=a},exit:function(){this.ON=!1}},meiView.Page=function(a,b){this.startMeasureN=a,this.endMeasureN=b},meiView.Pages=function(a){if(a=a||{},a.pages)this.pages=a.pages;else{this.pages=[];var b="undefined"!=typeof a.length?a.length:0,c=+("undefined"!=typeof a.mpp)?a.mpp:5;if(c>0)for(var d=0;b>d*c;++d)this.pages.push(new meiView.Page(d*c+1,Math.min(d*c+c,b)))}this.currentPageIndex=-1},meiView.Pages.prototype.AddPage=function(a,b){this.pages.push(new meiView.Page(a,b))},meiView.Pages.prototype.nextPage=function(){this.currentPageIndex<this.pages.length-1&&this.currentPageIndex++},meiView.Pages.prototype.jumpTo=function(a){a>=0&&a<this.pages.length&&(this.currentPageIndex=a)},meiView.Pages.prototype.jumpToMeasure=function(a){this.jumpTo(this.whichPage(a))},meiView.Pages.prototype.prevPage=function(){this.currentPageIndex>0&&this.currentPageIndex--},meiView.Pages.prototype.whichPage=function(a){var b=-1;return $.each(this.pages,function(c,d){d.startMeasureN<=a&&a<=d.endMeasureN&&(b=c)}),b},meiView.Pages.prototype.currentPage=function(){return this.pages[this.currentPageIndex]},meiView.Pages.prototype.totalPages=function(){return this.pages.length},meiView.Viewer.prototype.nextPage=function(){this.pages.nextPage(),this.displayCurrentPage(),this.UI.dlg&&this.UI.dlg.hide()},meiView.Viewer.prototype.prevPage=function(){this.pages.prevPage(),this.displayCurrentPage(),this.UI.dlg&&this.UI.dlg.hide()},meiView.Viewer.prototype.jumpTo=function(a){this.pages.jumpTo(a),this.displayCurrentPage()},meiView.Viewer.prototype.jumpToMeasure=function(a){this.pages.jumpToMeasure(a),this.displayCurrentPage()},meiView.Viewer.prototype.displayCurrentPage=function(){var a=this.getPageXML(this.pages.currentPage()),b=0===this.pages.currentPageIndex;this.UI.renderPage(a,{labelMode:b?"full":"abbr",systemLeftMar:b?100:25,page_margin_top:30,staveSpacing:70,systemSpacing:90,staff:{bottom_text_position:8,fill_style:"#000000"},vexWidth:this.scoreWidth,vexHeight:this.scoreHeight}),this.UI.displayDots(),this.UI.showTitle(b),this.UI.fabrCanvas.calcOffset(),this.UI.updatePageLabels(this.pages.currentPageIndex+1,this.pages.totalPages())},meiView.Viewer.prototype.selectSuppliedParts=function(a){var b={};for(var a in this.selectedSuppliedPartLists){var c=meiView.VarTypeList[a].attr,d=meiView.VarTypeList[a].el,e=meiView.VarTypeList[a].parent,f=this.selectedSuppliedPartLists[a].origins,g=$(this.MEI.rich_score).find(e);for(originID in f){var h;for(h=0;h<g.length;h++){var i=g[h],j=$(i).attr("xml:id");if(c)var k=$(i).find(d+"["+c+'="#'+originID+'"]');else var k=$(i).find(d+'[type="'+originID+'"]');var l;for(l=0;l<k.length;l++){var m=$(k[l]).attr("xml:id");b[j]&&f[originID]?b[j].push(m):!b[j]&&f[originID]?b[j]=[m]:b[j]||f[originID]||(b[j]=[])}}}}this.MEI.updateSectionView(b),this.displayCurrentPage()},meiView.Viewer.prototype.voiceNames=function(a){var b,c={};if(b="score"===a.localName?$(a).find("scoreDef"):$(a).find("score").find("scoreDef"),b.length>0){var d=$(b[0]).find("staffDef");$(d).each(function(){var a=$(this).attr("n")||"1";c[a]=$(this).attr("label")||"N/A"})}return c},meiView.Viewer.prototype.stavesToDisplay=function(a){var b=[];staffNs={},staffDefs=$(a).find("staffDef");var c;for(c=0;c<staffDefs.length;c++)sd=staffDefs[c],N=+$(sd).attr("n")||1,$(a).find('staff[n="'+N+'"]').length>0&&-1===b.indexOf(N)&&b.push(Number(N));return b},meiView.Viewer.prototype.selectVariant=function(a){this.selectingState.select(a);var b={};b[this.selectingState.appID]=a,this.MEI.updateSectionView(b)},meiView.Viewer.prototype.getPageXML=function(a){var b=1!==a.startMeasureN;return staves=this.stavesToDisplay(this.MEI.sectionview_score),this.MEI.getSectionViewSlice({start_n:a.startMeasureN,end_n:a.endMeasureN,noMeter:b,staves:staves})},meiView.Viewer.prototype.loadXMLString=function(a){var b;return window.DOMParser?(parser=new DOMParser,b=parser.parseFromString(a,"text/xml")):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.loadXML(a)),b},meiView.UI=function(a){this.init(a)},meiView.UI.prototype.init=function(a){this.viewer=a.viewer,this.maindiv=a.maindiv,this.main_id="meiview-main-"+this.viewer.id,this.canvas_id="meiview-canvas-"+this.viewer.id,this.score_id="meiview-score-"+this.viewer.id,this.base_html='<div class="meiview-main" id="'+this.main_id+'" style="margin: 10px 20px auto">    <div id="'+this.score_id+'" align="center" class="ui-widget-content meiview-scorediv meiview-sized-scorediv">    	<button class="ui-widget-content ui-corner-all"onclick="meiView.UI.callback(\''+this.viewer.id+'\', \'prevPage\')"><span class="ui-icon ui-icon-triangle-1-w"/></button>    	<span id="pageNumber-top" width="10">0/0</span>    	<button class="ui-widget-content ui-corner-all" onclick="meiView.UI.callback(\''+this.viewer.id+'\', \'nextPage\')"><span class="ui-icon ui-icon-triangle-1-e"/></button>    	<div id="titlediv"><h4><span id="title" class="title" property="dc:title"></span></h4></div>    	<canvas class="canvas" id="'+this.canvas_id+'" width="780" height="700"></canvas>    	<button class="ui-widget-content ui-corner-all"onclick="meiView.UI.callback(\''+this.viewer.id+'\', \'prevPage\')"><span class="ui-icon ui-icon-triangle-1-w"/></button>    	<span id="pageNumber-bottom" width="10">0/0</span>    	<button class="ui-widget-content ui-corner-all" onclick="meiView.UI.callback(\''+this.viewer.id+'\', \'nextPage\')"><span class="ui-icon ui-icon-triangle-1-e"/></button>    </div>    <div id="sidebar">    	<div id="accordion">     	</div>    	<div id="legend" >    		<p>    			<ul>    				<li><h5>Click on the green dots to view the differences between the sources!</h5></li>    				<li class=".meiview-source-has-variant-on">    					When a  <text style="color: rgb(190,0,0)">Source is highlighted</text> it means some of its     					variants are currently displayed in the score.    				</li>    				<li>    					When a <text style="color: rgb(185,0,0);">Variant is highlighted</text> it means that variant is currently     					displayed in the score.    				</li>    			</ul>    		</p>    	</div>    </div>   </div>',$(this.maindiv).append(this.base_html),this.titleDiv=$(this.maindiv).find(".titlediv"),this.dots={},this.measure_n_texts={},meiView.UI.addObject(this.viewer.id,this.viewer),meiView.UI.addObject(this.viewer.id+"-ui",this),$(this.maindiv).find("#sidebar").position({my:"left",at:"right+10",of:$("#"+this.score_id)});var b=$("#"+this.score_id).height(),c=Number(b);$(this.maindiv).find("#sidebar").css("top",-1*c-20),$(this.maindiv).css("height",this.maxHeight()+20),$("#"+this.main_id).css("height",this.maxHeight()+20);var d=$(this.maindiv).find("span.title")[0];$(d).html(a.title),this.fillSideBar($(this.maindiv).find("#accordion"),"meiview-sidebar"),$(this.maindiv).find("#accordion").accordion({collapsible:!0,heightStyle:"content",active:!1}),this.fabrCanvas=this.initCanvas(this.canvas_id),this.initSidebarHighlight()},meiView.UI.prototype.maxHeight=function(){var a=$("#"+this.score_id).height(),b=Number(a),c=0,d=$(this.maindiv).find("#sidebar")[0];return d&&(str_sideH=$(d).height(),c=Number(str_sideH)),Math.max(b,c)},meiView.UI.prototype.toCSSId=function(a){return a.replace(/#/g,"").replace(/\./g,"_")},meiView.UI.prototype.liID=function(a,b){return this.toCSSId(a)+"-"+this.toCSSId(b)},meiView.UI.prototype.srcID2srcLabel=function(a){return"lem"===a?"Base text":"Source "+a.replace(/^#/,"")},meiView.UI.prototype.originID2originLabel=function(a){return"sic"===a?"Sic (mistakes in base text)":"Corrected by "+a.replace(/^#/,"")},meiView.UI.prototype.choiceItem2choiceItemLabel=function(a){var b="";return"sic"===a.localName?b="sic":"corr"===a.localName&&(b="corr. by "+$(a).attr("resp").replace(/^#/,"")),b},meiView.UI.prototype.shortVoiceLabel=function(a){var b="",c=$(a).closest("staff");if(c.length>0){var d,e=c.attr("n")||"1",f=$(a).closest("score").find('staffDef[n="'+e+'"]');for(d=0;d<f.length;++d)b=$(f[d]).attr("label.abbr")||$(f[d]).attr("label")||b;b.length>4&&(b=b.substr(0,1))}return b},meiView.UI.prototype.appID2appLabel=function(a){var b=$(this.viewer.MEI.rich_score).find('app[xml\\:id="'+a+'"], choice[xml\\:id="'+a+'"]'),c=b.closest("measure"),d="M"+c.attr("n"),e=b.closest("staff");if(e.length>0){var f,g=e.attr("n")||"1",h=b.closest("score").find('staffDef[n="'+g+'"]'),i="";for(f=0;f<h.length;++f)i=$(h[f]).attr("label.abbr")||$(h[f]).attr("label")||i;i.length>4&&(i=i.substr(0,1))}return d+="."+this.shortVoiceLabel(b)},meiView.UI.prototype.showTitle=function(a){this.titleDiv&&this.titleElem&&(a?$(this.titleDiv).append(this.titleElem):$(this.titleElem).remove())},meiView.UI.prototype.updatePageLabels=function(a,b){$(this.maindiv).find("#pageNumber-top, #pageNumber-bottom").html(a.toString()+"/"+b)},meiView.UI.prototype.onClickSideBarMarkup=function(a,b,c){var d="onclick=\"meiView.UI.callback('"+a.viewer.id+"-ui', 'onClickSidebarItem', { measure_n: "+b+", altID: '"+c+"'})\"";return d},meiView.UI.prototype.fillSideBar=function(a,b){cap_plural=function(a){return a.charAt(0).toUpperCase()+a.slice(1)+"s"};for(var c in this.viewer.SuppliedPartLists)for(originID in this.viewer.SuppliedPartLists[c]){var d=a.find('ul[id="'+c+'"]');0===d.length&&(a.append('<h3 class="'+b+'">'+cap_plural(c)+'</h3><div class="'+b+'"><ul id="'+c+'"></ul></div>'),d=a.find('ul[id="'+c+'"]')),d.append('<li class="meiview-sidebar-item"          onclick="meiView.UI.callback(\''+this.viewer.id+"-ui', 'onSuppliedPartClick', { originID: '"+originID+"',var_type: '"+c+"',})\">"+("blank"==originID?"Show missing staves":originID)+"</li>")}var e=(this.viewer.Emendations,$(this.viewer.MEI.rich_score).find("choice"));if(e.length>0){a.append('<h3 class="'+b+'">Emendations</h3>        <div class="'+b+'">          <ul class="emendations-list"></ul>        </div>');for(var f,g=a.find("ul.emendations-list"),f=0;f<e.length;f++){for(var h,i=e[f],j=$($(i).closest("measure")[0]).attr("n"),k=$(i).attr("xml:id"),l=this.toCSSId(k),m="",n=$(i).find("corr"),o="(corr. by ",p=")",h=0;h<n.length;h++){var q=n[h];m+=(h>0?", ":"")+$(q).attr("resp").replace(/^#/,"")}g.append('<li id="'+l+'" class="meiview-sidebar-item" '+this.onClickSideBarMarkup(this,j,k)+">"+this.appID2appLabel(k)+o+m+p+"</li>");{$(g).find("li#"+l)}}}var r=this.viewer.Sources;for(src in r){var s=r[src];a.append('<h3 class="'+b+'">'+this.srcID2srcLabel(src)+'</h3><div class="'+b+'"><ul id="'+src+'"></ul></div>');for(var d=a.find('ul[id="'+src+'"]'),f=0;f<s.length;f++){var t=s[f].appID,j=s[f].measureNo;d.append('<li id="'+this.liID(src,t)+'" class="'+this.toCSSId(t)+' meiview-sidebar-item" '+this.onClickSideBarMarkup(this,j,t)+">"+this.appID2appLabel(t)+"</li>")}}},meiView.UI.callback=function(a,b,c){meiView.UI.objects[a][b](c)},meiView.UI.prototype.onSuppliedPartClick=function(a){this.viewer.toggleSuppliedPart(a.var_type,a.originID)},meiView.UI.objects={},meiView.UI.addObject=function(a,b){meiView.UI.objects[a]=b},meiView.UI.prototype.onClickSidebarItem=function(a){this.viewer.jumpToMeasure(a.measure_n),this.ShowSelectorPanel(this.dots[a.altID].info)},meiView.UI.prototype.renderMei2Canvas=function(a,b){b=b||{};var c=(b.paddingX||0,b.paddingY||0,new fabric.StaticCanvas);c.setDimensions({width:b.vexWidth,height:b.vexHeight});var d=b.vexWidth,e=b.vexHeight;return this.L("Rendering MEI... "),MEI2VF.render_notation(a,c.getElement(),d,e,null,b),this.rendered_measures=MEI2VF.rendered_measures,this.L("Done rendering MEI"),c},meiView.UI.prototype.displayDots=function(){for(appID in this.dots)this.dots[appID]&&(this.fabrCanvas.remove(this.dots[appID].circle),delete this.dots[appID]);for(appID in this.viewer.MEI.ALTs)this.dots[appID]=this.displayDotForAPP(appID)},meiView.UI.prototype.displayDotForAPP=function(a){var b,c=this.viewer.MEI.ALTs[a].elem,d=$(c).parents("measure"),e=d.attr("n"),f=$(c).parents("staff");if(0===f.length){var g=$(c).find("[staff]");b=$(g).attr("staff")}else b=f.attr("n");var h=MEI2VF.rendered_measures[e];if(h){var i=h[b];if(i){var j={appXmlID:a,measure_n:Number(e),measure_top:i.y,measure_left:i.x,measure_width:i.width,staff_n:Number(b)};return{circle:this.displayDotForMeasure(i),info:j}}}},meiView.UI.prototype.displayDotForMeasure=function(a){if(a){var b=(a.x+a.width-12)*this.scale,c=(a.y+25)*this.scale,d=new fabric.Circle({radius:5,fill:"green",left:b,top:c,lockMovementX:!0,lockMovementY:!0,lockScalingX:!0,lockScalingY:!0,lockRotation:!0,hasControls:!1,hasBorders:!1});return d.meiViewID=appID,this.fabrCanvas.add(d),d}},meiView.UI.prototype.displayMeasureNos=function(){console.log("meiView.UI.prototype.displayMeasureNos()");for(n in this.measure_n_texts)this.measure_n_texts[n]&&(this.fabrCanvas.remove(this.measure_n_texts[n]),delete this.measure_n_texts[n]);var a=this.rendered_measures,b=this.scale,c=this.fabrCanvas,d=this.measure_n_texts;$.each(a,function(a,e){if(console.log("meiView.UI.prototype.displayMeasureNos() n:"+a),e){var f,g=e[1],h=!1;for(f=0;f<g.modifiers.length;f++){var i=g.modifiers[f];(i.volta==Vex.Flow.Volta.type.BEGIN||i.volta==Vex.Flow.Volta.type.BEGIN_END)&&(h=!0)}if(!h){console.log("meiView.UI.prototype.displayMeasureNos() vexStaff:"),console.log(g);var j=(g.x+8)*b,k=(g.y+15)*b,l=new fabric.Text(a.toString(),{fontSize:Math.round(16*b),fill:"grey",left:j,top:k,lockMovementX:!0,lockMovementY:!0,lockScalingX:!0,lockScalingY:!0,lockRotation:!0,hasControls:!1,hasBorders:!1});c.add(l),d[a]=l}}})},meiView.UI.prototype.renderMei2Img=function(a,b){var c=this.renderMei2Canvas(a,b),d=new Image;return d.src=c.toDataURL(),d},meiView.UI.prototype.renderPage=function(a,b){b=b||{},b.paddingX=20,b.paddingY=20,b.vexWidth=b.vexWidth||$(this.fabrCanvas.getElement()).attr("width"),b.vexHeight=b.vexHeight||$(this.fabrCanvas.getElement()).attr("height");var c=this.renderMei2Img(a,b);this.scoreImg&&this.fabrCanvas.remove(this.scoreImg),this.scale=this.fabrCanvas.width/b.vexWidth;var d=this.fabrCanvas.width,e=b.vexHeight*this.scale;this.scoreImg=new fabric.Image(c,{width:d,height:e,left:d/2,top:e/2,lockMovementX:!0,lockMovementY:!0,lockScalingX:!0,lockScalingY:!0,lockRotation:!0,hasControls:!1,hasBorders:!1,selectable:!1}),this.fabrCanvas.add(this.scoreImg),this.viewer.display_measure_numbers&&this.displayMeasureNos(),this.fabrCanvas.renderAll_Hack()},meiView.UI.prototype.initCanvas=function(a){var b={width:$("#"+a).width(),height:$("#"+a).height()},c=this,d=new fabric.Canvas(a);d.setDimensions(b),d.hoverCursor="pointer";var e=this;return d.renderAll_Hack=function(){setTimeout(function(){d.renderAll()},1e3)},d.findTarget=function(a){return function(){var b=a.apply(this,arguments);return b?this._hoveredTarget!==b&&(d.fire("object:over",{target:b}),this._hoveredTarget&&d.fire("object:out",{target:this._hoveredTarget}),this._hoveredTarget=b):this._hoveredTarget&&(d.fire("object:out",{target:this._hoveredTarget}),this._hoveredTarget=null),b}}(d.findTarget),d.on("object:over",function(a){a.target&&a.target.meiViewID&&(a.target.setFill("red"),d.renderAll())}),d.on("object:out",function(a){a.target&&a.target.meiViewID&&(a.target.setFill("green"),d.renderAll())}),d.on("mouse:down",function(a){if(a.target){var b=a.target.meiViewID&&e.dots[a.target.meiViewID]&&e.dots[a.target.meiViewID].info;b?e.ShowSelectorPanel(b):a.target.selectItem>=0?e.dlg&&e.dlg.select(a.target.selectItem):e.HideSelectorPanel(),c.L(a.target),c.L(a.target.meiViewID+": x:"+a.target.left+", y:"+a.target.top)}}),d.allowTouchScrolling=!0,d},meiView.UI.prototype.onSelectorDraw=function(a){this.viewer.selectingState.enter(a.appID,this.viewer.MEI.sectionplane[a.appID].xmlID),this.updateSidebar()},meiView.UI.prototype.onSelectorSelect=function(a){if(this.viewer.selectingState.ON){var b=this.viewer.selectingState.selectedVarXmlID;this.viewer.selectVariant(a.varXmlID),this.viewer.displayCurrentPage(),this.dlg&&this.dlg.bringToFront(),this.updateSidebar(this.viewer.selectingState.appID,b)}},meiView.UI.prototype.onSelectorHide=function(){this.viewer.selectingState.exit(),this.updateSidebar()},meiView.UI.prototype.addHightlightClasses=function(a){for(var b=this.viewer.MEI.sectionplane[a].source,c=b?b.split(" "):["lem"],d=0;d<c.length;d++){var e=this.liID(c[d],a);$(this.maindiv).find("#"+e).addClass("meiview-variant-on").closest("div.meiview-sidebar").prev().addClass("meiview-source-has-variant-on")}},meiView.UI.prototype.initSidebarHighlight=function(){if(this.viewer.MEI.sectionview_socre)for(appID in this.viewer.MEI.ALTs)this.addHightlightClasses(appID)},meiView.UI.prototype.updateSidebarHighlight=function(a,b){if(this.addHightlightClasses(a),b){source=this.viewer.MEI.ALTs[a].altitems[b].source;for(var c=source?source.split(" "):["lem"],d=0;d<c.length;d++){var e=this.liID(c[d],a);$(this.maindiv).find("#"+e).removeClass("meiview-variant-on")}$(this.maindiv).find("div.meiview-sidebar").not(":has(li.meiview-variant-on)").prev(".meiview-source-has-variant-on").removeClass("meiview-source-has-variant-on")}},meiView.UI.prototype.updateSidebar=function(a,b){a&&this.updateSidebarHighlight(a,b),this.viewer.selectingState.ON?($(this.maindiv).find("div.meiview-sidebar").not(":has(li."+this.toCSSId(this.viewer.selectingState.appID)+")").prev().addClass("meiview-source-disabled"),$(this.maindiv).find(".meiview-source-disabled.ui-accordion-header-active").length>0&&$(this.maindiv).find("#accordion").accordion("option","active",!1),$(this.maindiv).find("#accordion").on("accordionbeforeactivate",function(a){a.preventDefault()})):($(this.maindiv).find("h3.meiview-source-disabled").removeClass("meiview-source-disabled"),$(this.maindiv).find("#accordion").off())},meiView.UI.prototype.ShowSelectorPanel=function(a){var b=this.viewer.MEI.getRichSlice({start_n:a.measure_n,end_n:a.measure_n,staves:[a.staff_n],noClef:!0,noKey:!0,noMeter:!0,noConnectors:!0}),c=a.appXmlID,d=this.viewer.MEI.ALTs[c].altitems;this.dlg&&this.dlg.hide(),this.dlg=new meiView.SelectorPanel({left:a.measure_left*this.scale,top:a.measure_top*this.scale,measureWidth:500*this.scale,canvas:this.fabrCanvas,scale:.7,appID:c,UI:this}),self=this,this.dlg.onDraw=function(a){self.onSelectorDraw(a)},this.dlg.onSelect=function(a){self.onSelectorSelect(a)},this.dlg.onHide=function(){self.onSelectorHide()},b.initSectionView();for(xmlID in d){var e=d[xmlID],f=e.tagname,g=e.source,h=e.resp,i={};i[c]=xmlID,b.updateSectionView(i);var j="";"lem"==f?j="Lemma":"sic"==f?j="Original":"corr"==f?j=h?"Corrected ("+h.replace(/#/g,"").replace(/ /g,", ")+")":"Corrected":g?j=g.replace(/#/g,"").replace(/ /g,", "):h&&(j=h.replace(/#/g,"").replace(/ /g,", "));var k=this.viewer.MEI.sectionplane[c]===e;this.dlg.addItem(j+":",b.sectionview_score,k,xmlID)}this.dlg.draw()},meiView.UI.prototype.HideSelectorPanel=function(){this.dlg&&this.dlg.hide()},meiView.DO_LOG=!0,meiView.UI.prototype.L=function(){meiView.DO_LOG&&Vex.L("meiView",arguments)},meiView.SelectorItem=function(a){this.text=a.text,this.imgData=a.imgData,this.xmlID=xmlID},meiView.SelectorPanel=function(a){if(this.measureWidth=a.measureWidth||300,this.measureHeight=a.measureHeight||125,this.scale=a.scale||.8,this.marginWE=a.marginWE||5,this.marginNS=a.marginNS||this.marginWE,this.itemSpacing=a.itemSpacing||5,this.width=this.measureWidth*this.scale,this.height=0,this.selectedIndex=a.currentSelection||-1,this.left=a.left||this.width/2,this.top=a.top||this.height/2,this.canvas=a.canvas,this.UI=a.UI,this.contentWidth=this.width-2*this.marginWE,this.imgW=this.contentWidth,this.imgH=this.imgW*this.measureHeight/this.measureWidth,this.contentTop=this.top-this.height/2+this.marginNS,this.contentScale=a.contentScale||.7,this.items=[],this.objects=[],!a.appID)throw"appID isn't defined for SelectorPanel.";this.appID=a.appID,this.onDraw=function(){},this.onSelect=function(){},this.onHide=function(){}},meiView.SelectorPanel.prototype.setCanvas=function(a){this.canvas=a},meiView.SelectorPanel.prototype.addItem=function(a,b,c,d){var e=this.UI.renderMei2Img(b,{labelMode:"full",systemLeftMar:100,page_margin_top:20,staveSpacing:70,systemSpacing:90,staff:{bottom_text_position:8,fill_style:"#000000"},vexWidth:this.measureWidth,vexHeight:this.measureHeight}),f=new meiView.SelectorItem({text:a,imgData:e,xmlID:d});this.items.push(f),c&&this.select(this.items.length-1)},meiView.SelectorPanel.prototype.addObjectsForItem=function(a,b){var c=new fabric.Text(a.text,{fontSize:17*this.scale,selectable:!1,left:this.left});c.width>this.contentWidth&&(this.contentWidth=c.width,this.width=this.contentWidth+2*this.marginWE);var d=new fabric.Image(a.imgData,{width:this.imgW,height:this.imgH,left:this.left,lockMovementX:!0,lockMovementY:!0,lockScalingX:!0,lockScalingY:!0,lockRotation:!0,hasControls:!1,hasBorders:!0,selectable:!1}),e=c.getBoundingRect();c.top=this.contentTop+this.nextItemTop+e.height/2,d.top=c.top+e.height/2+d.height/2;var f=c.height+d.height;a.height=f,this.nextItemTop+=f+this.itemSpacing;var g=0===b?f+this.marginNS:f+this.itemSpacing;this.height+=g,this.top+=g/2;var h=this.contentWidth,i=this.imgH+c.height;a.selectorMask=new fabric.Rect({fill:"green",width:h,height:i,left:this.left,lockMovementX:!0,lockMovementY:!0,lockScalingX:!0,lockScalingY:!0,lockRotation:!0,hasControls:!1,selectable:!0}),a.selectorMask.top=a.selectorMask.height/2+c.top-c.height/2,a.selectorMask.selectItem=b,a.selectorMask.highlight=function(a){this.opacity=a?.35:0},a.selectorMask.highlight(b===this.selectedIndex),this.objects.push(c),this.objects.push(d),this.objects.push(a.selectorMask)},meiView.SelectorPanel.prototype.shiftXY=function(a){for(var b=0,c=this.items,d=0;d<c.length;d++)b+=c[d].height+(0===d?this.marginNS:this.itemSpacing);c.length>0&&(b+=this.marginNS);var e=this.width,f=a.width,g=a.height,h=a.x,i=a.y,j=this.panel.left,k=this.panel.top,l=h-f/2+e/2,m=h+f/2-e/2,n=0;j>m&&(n=m-j),l>j&&(n=l-j);var o=i-g/2+b/2,p=i+g/2-b/2,q=0;return k>p&&(q=p-k),o>k&&(q=o-k),{x:n,y:q}},meiView.SelectorPanel.prototype.draw=function(){this.objects=[],this.nextItemTop=0,this.panel||(this.panel=new fabric.Rect({fill:"grey",selectable:!1})),this.objects.push(this.panel);for(var a=this.items,b=0;b<a.length;b++)this.addObjectsForItem(a[b],b);this.panel.width=this.width,this.panel.height=this.height+this.marginNS,this.panel.left=this.left,this.panel.top=this.top+this.marginNS/2;for(var c=this.shiftXY({x:this.canvas.width/2,y:this.canvas.height/2,width:this.canvas.width,height:this.canvas.height}),d=this.objects,b=0;b<d.length;b++){var e=d[b];e.left+=c.x,e.top+=c.y,this.canvas.add(e)}this.canvas.renderAll_Hack(),this.onDraw({appID:this.appID})},meiView.SelectorPanel.prototype.hide=function(){this.canvas.remove(this.panel);for(var a=this.objects,b=0;b<a.length;b++)this.canvas.remove(a[b]);this.onHide(),delete this},meiView.SelectorPanel.prototype.select=function(a){a>=0&&a<this.items.length&&(this.selectedIndex>=0&&this.items[this.selectedIndex].selectorMask&&this.items[this.selectedIndex].selectorMask.highlight(!1),this.items[a].selectorMask&&this.items[a].selectorMask.highlight(!0),this.selectedIndex=a,this.onSelect({varXmlID:this.items[a].xmlID}))},meiView.SelectorPanel.prototype.bringToFront=function(){for(var a=this.objects,b=0;b<a.length;b++)a[b].bringToFront()},meiView="undefined"==typeof meiView?{}:meiView,meiView.substituteLonga=function(a){var b=$(a).find('note[dur="long"]');$(b).each(function(){$(this).attr("dur","breve")})},meiView.filterMei=function(a,b){var b=b||{},c=function(a){var b=function(a,b,c){var d=$(b).attr(a),e=$(c).attr(a);!d&&e&&$(b).attr(a,e)},c=$(a).find("staffDef");$(c).each(function(){b("meter.count",this,a),b("meter.unit",this,a),b("meter.rend",this,a),b("key.pname",this,a),b("key.accid",this,a),b("key.mode",this,a),b("key.sig.show",this,a)})},d=function(b){var c=function(b){var c=$(b).attr("place"),d=$(b).attr("func");if("above"==c&&"edit"==d){var e=$(b).parent("supplied").parent("note").attr("xml:id");if(e){var f=a.createElementNS("http://www.music-encoding.org/ns/mei","dir");$(f).attr("startid",e);var g=$(b).attr("accid");"s"==g?$(f).append("♯"):"n"==g?$(f).append("♮"):"f"==g&&$(f).append("♭"),$(b).closest("staff").get(0).parentNode.appendChild(f)}else console.log("parent note xml:id is needed in order to attach ficta. Ficta will be ignored.")}else $(b).parent("note").attr("accid",$(b).attr("accid"));b.parentNode.removeChild(b)},d=$(b).find("accid");$(d).each(function(){c(this)})},e=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","music")[0];$(e).find("pb").remove();var f=$(e).find("scoreDef");return $(f).each(function(){c(this)}),b.noSysBreak&&$(e).find("sb").remove(),$(e).find("meterSig").remove(),$(e).find('annot[type="bracket"]').remove(),meiView.substituteLonga(e),d(e),a},meiView.Mode={SINGLE_PAGE:0,PLAIN:1,SIDEBAR_ONLY:2,CRITREP_ONLY:3,FULL:4},meiView.Merge=function(a,b){for(var c in b)a[c]=b[c];return a},meiView.Inherit=function(){var a=function(){};return function(b,c,d){return a.prototype=c.prototype,b.prototype=new a,b.superclass=c.prototype,b.prototype.constructor=b,meiView.Merge(b.prototype,d),b}}(),meiView.CompactViewer=function(a){this.init(a)},meiView.Inherit(meiView.CompactViewer,meiView.Viewer,{init:function(a){var b=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-8)};this.mode="undefined"==typeof a.mode?meiView.Mode.FULL:a.mode,this.id="undefined"==typeof $(a.maindiv).attr("id")?b():$(a.maindiv).attr("id"),this.MEI=a.MEI,this.MEI.initSectionView(),this.display_measure_numbers="undefined"==typeof a.display_measure_numbers?1:a.display_measure_numbers,a.pages?this.pages=a.pages:(this.pages=new meiView.Pages,this.parsePages&&this.parsePages(this.MEI)),a.pxpMeasure?this.pxpMeasure=a.pxpMeasure:this.scoreWidth=a.width||1200,this.scoreHeight=a.height||1e3,this.createSourceList(this.MEI.ALTs),this.SuppliedPartLists={};for(var c in meiView.VarTypeList)this.SuppliedPartLists[c]=this.createSuppliedPartList(c);this.selectedSuppliedPartLists={};for(var c in meiView.VarTypeList)this.selectedSuppliedPartLists[c]=new meiView.SelectedSuppliedPartList(c);this_viewer=this,this.UI=new meiView.CompactUI({viewer:this_viewer,maindiv:a.maindiv,title:a.title,scale:a.scale}),this.mode==meiView.Mode.FULL||(this.mode==meiView.Mode.CRITREP_ONLY?this.UI.hideSideBar():this.mode==meiView.Mode.SIDEBAR_ONLY?this.UI.hideCritRep():this.mode==meiView.Mode.PLAIN?(this.UI.hideSideBar(),this.UI.hideCritRep()):this.mode==meiView.Mode.SINGLE_PAGE&&(this.UI.hideSideBar(),this.UI.hideCritRep(),this.UI.hidePagination())),0==this.UI.sideBarLength()&&this.UI.hideSideBar(),a.displayFirstPage&&this.nextPage()},getScoreWidth:function(a){if(this.pxpMeasure){var b=$(a).find("measure").length;return this.pxpMeasure*b}return this.scoreWidth},toggleCritRep:function(){this.UI.critRepOn()?this.UI.hideCritRep():this.UI.showCritRep()},getPageXML_ContentPart:function(a){var b=1!==a.startMeasureN,c=this.stavesToDisplay(this.MEI.sectionview_score),d=this.MEI.getSectionViewSlice({start_n:a.startMeasureN,end_n:a.endMeasureN,noMeter:b,noKey:!0,noClef:!0,staves:c}),e=$(d).find("scoreDef");return e[0]&&$(e[0]).find("staffGrp").attr("symbol","none"),d},getPageXML_ClefPart:function(){var a,b,c,d,e,f,g,h,i=this;return console.log("getPageXML_ClefPart() {start}"),a=i.stavesToDisplay(this.MEI.sectionview_score),b=i.MEI.getSectionViewSlice({start_n:"-1",noMeter:!0,noKey:!1,noClef:!1,staves:a}),c=b,c&&(console.log("getPageXML_ClefPart() {I}"),d=$(c).find("scoreDef"),e=d[0],f=$(c).find("section").get(0),g=i.MEI.xmlDoc.createElementNS("http://www.music-encoding.org/ns/mei","measure"),g.setAttribute("n","1"),g.setAttribute("right","invis"),e&&($(d[0]).find("staffDef").each(function(a,b){var c,d;f&&(h=$(b).attr("n"),c=i.MEI.xmlDoc.createElementNS("http://www.music-encoding.org/ns/mei","staff"),c.setAttribute("n",h),d=i.MEI.xmlDoc.createElementNS("http://www.music-encoding.org/ns/mei","layer"),c.appendChild(d),g.appendChild(c))}),f.appendChild(g))),b},displayCurrentPage:function(){this.displayCurrentPage_TwoParts()},displayCurrentPage_TwoParts:function(){var a=this.getPageXML_ContentPart(this.pages.currentPage()),b=this.getPageXML_ClefPart(this.pages.currentPage());this.UI.renderContentPart(a,{vexWidth:this.getScoreWidth(a),vexHeight:this.scoreHeight}),this.UI.rendered_measures=MEI2VF.rendered_measures,this.UI.content_dims=MEI2VF.Converter.getStaffArea(),this.UI.updateMainHeight();var c={};c.page_margin_right=0,c.page_margin_left=10,c.scale=this.UI.scale,c.vexHeight=this.scoreHeight,this.UI.renderClefPart(b,c),this.UI.rendered_clefmeasures=MEI2VF.rendered_measures,this.UI.resizeElements(),this.UI.displayDots(),this.UI.showTitle(0===this.pages.currentPageIndex),this.UI.updatePageLabels(this.pages.currentPageIndex+1,this.pages.totalPages()),this.UI.displayVoiceNames(b,{x:c.page_margin_left+20}),this.UI.fabrCanvas.calcOffset()
},nextPage:function(){this.pages.nextPage(),this.displayCurrentPage_TwoParts(),this.UI.dlg&&this.UI.dlg.hide()},prevPage:function(){this.pages.prevPage(),this.displayCurrentPage_TwoParts(),this.UI.dlg&&this.UI.dlg.hide()},jumpTo:function(a){this.pages.jumpTo(a),this.displayCurrentPage_TwoParts(),this.UI.dlg&&this.UI.dlg.hide()},jumpToMeasure:function(a){this.pages.jumpToMeasure(a),this.displayCurrentPage_TwoParts(),this.UI.dlg&&this.UI.dlg.hide()}}),meiView.CompactUI=function(a){this.init(a)},meiView.Inherit(meiView.CompactUI,meiView.UI,{init:function(a){this.options=a||{},this.viewer=a.viewer,this.maindiv=a.maindiv,this.canvas_id="meiview-canvas-"+this.viewer.id,this.canvas_clef_id="meiview-canvas-clef-"+this.viewer.id,$(this.maindiv).attr("id",this.viewer.id),$(this.maindiv).addClass("meiview-main"),$(this.maindiv).addClass("ui-widget-content");var b=function(a,b){return'<button class="ui-widget-content ui-corner-all" onclick="meiView.UI.callback(\''+b+"', '"+a+'Page\')">        <span class="ui-icon ui-icon-triangle-1-'+("next"!==a?"prev"!==a?"":"w":"e")+'"/></button>'};this.base_html='    <div class="main-area">      <div class="pagination-div" align="center">'+b("prev",this.viewer.id)+'<span id="pageNumber-top" width="10">0/0</span>'+b("next",this.viewer.id)+'</div>      <div class="meiview-canvas-container">        <div class="clef-canvas-div">          <canvas class="clef-canvas" id="'+this.canvas_clef_id+'"></canvas>        </div>        <div class="main-canvas-div" onscroll="meiView.UI.callback(\''+this.viewer.id+'-ui\', \'onScrollMainCanvas\', {})">          <canvas class="main-canvas" id="'+this.canvas_id+'"></canvas>        </div>      </div>      <div class="critrep-div ui-widget-content ui-corner-top" onclick="toggleCritRep()">      </div>      <div class="pagination-div" align="center">'+b("prev",this.viewer.id)+'<span id="pageNumber-top" width="10">0/0</span>'+b("next",this.viewer.id)+'</div>      <div class="sidebar ui-widget-content ui-corner-left" id="sidebar">        <div id="accordion">        </div>      </div>    </div>    ',$(this.maindiv).append(this.base_html),this.main_area=$(this.maindiv).find(".main-area"),this.options.sidebar_ratio="undefined"==typeof this.options.sidebar_ratio?.2:this.options.sidebar_ratio,this.titleDiv=$(this.maindiv).find(".titlediv"),this.dots={},this.measure_n_texts={},meiView.UI.addObject(this.viewer.id,this.viewer),meiView.UI.addObject(this.viewer.id+"-ui",this);var c=$(this.maindiv).find("span.title")[0];$(c).html(a.title),this.fillSideBar($(this.maindiv).find("#accordion"),"meiview-sidebar"),$(this.maindiv).find("#accordion").accordion({collapsible:!0,heightStyle:"fill",active:!1}),0===$(this.maindiv).find("#accordion h3").length&&this.hideSideBar(),this.fillCritReport(),this.scale=a.scale||1,this.fabrCanvas=this.initCanvas(this.canvas_id),this.canvasClef=$(this.maindiv).find(".clef-canvas").get();var d={width:$(this.canvasClef).width(),height:$(this.canvasClef).height()};this.fabrCanvasClef=new fabric.StaticCanvas(this.canvas_clef_id),this.fabrCanvasClef.setDimensions(d),this.initSidebarHighlight();var e=this;$(window).on("resize",function(){console.log("window resized"),e.resizeElements()})},updateMainHeight:function(){var a=$(this.maindiv).find("#accordion h3"),b=($(this.maindiv).find(".sidebar"),100),c=a.length*a.height()+b,d=Math.max((this.content_dims.height+150)*this.scale,c);$(this.maindiv).find(".main-canvas-div").height(d),this.fabrCanvas.setDimensions({height:d}),this.fabrCanvasClef.setDimensions({height:d}),this.resizeElements()},maxCritRep:function(){$(this.maindiv).find(".critrep-div").removeClass("critrep-min"),$(this.maindiv).find(".critrep-div").addClass("critrep-max"),this.resizeElements()},minCritRep:function(){$(this.maindiv).find(".critrep-div").removeClass("critrep-max"),$(this.maindiv).find(".critrep-div").addClass("critrep-min"),this.resizeElements()},critRepState:function(){return $(this.maindiv).find("critrep-div").hasClass("critrep-min")?"critrep-min":$(this.maindiv).find("critrep-div").hasClass("critrep-max")?"critrep-max":void 0},showCritRep:function(){$(this.maindiv).find(".critrep-div").css("display","block"),this.resizeElements()},hideCritRep:function(){$(this.maindiv).find(".critrep-div").css("display","none"),this.resizeElements()},critRepOn:function(){return"none"!==$(this.maindiv).find(".critrep-div").css("display")},showPagination:function(){$(this.maindiv).find(".pagination-div").css("display","block"),this.resizeElements()},hidePagination:function(){$(this.maindiv).find(".pagination-div").css("display","none"),this.resizeElements()},paginationOn:function(){return"none"!==$(this.maindiv).find(".pagination-div").css("display")},onScrollMainCanvas:function(){this.fabrCanvas.calcOffset()},showSideBar:function(){$(this.maindiv).find(".sidebar").css("display","block"),this.resizeElements()},hideSideBar:function(){$(this.maindiv).find(".sidebar").css("display","none"),this.resizeElements()},sideBarLength:function(){return $(this.maindiv).find(".sidebar").find("h3.meiview-sidebar").length},sideBarOn:function(){return"none"!==$(this.maindiv).find(".sidebar").css("display")},renderContentPart:function(a,b){b=b||{},b.page_margin_left=0,b.page_margin_right=20,b.vexWidth=b.vexWidth||$(this.fabrCanvas.getElement()).attr("width"),b.vexHeight=b.vexHeight||$(this.fabrCanvas.getElement()).attr("height");var c=this.renderMei2Img(a,b);this.scoreImg&&this.fabrCanvas.remove(this.scoreImg),this.fabrCanvas.setDimensions({width:b.vexWidth*this.scale});var d=b.vexWidth*this.scale,e=b.vexHeight*this.scale;this.scoreImg=new fabric.Image(c,{width:d,height:e,left:d/2,top:e/2,lockMovementX:!0,lockMovementY:!0,lockScalingX:!0,lockScalingY:!0,lockRotation:!0,hasControls:!1,hasBorders:!1,selectable:!1}),this.fabrCanvas.add(this.scoreImg),this.viewer.display_measure_numbers&&this.displayMeasureNos(),this.fabrCanvas.renderAll_Hack()},renderClefMei:function(a,b,c){c=c||{},c.vexWidth=c.vexWidth||$(this.fabrCanvas.getElement()).attr("width"),c.vexHeight=c.vexHeight||$(this.fabrCanvas.getElement()).attr("height"),c.scale=c.scale||1;var d=c.vexWidth,e=c.vexHeight;a.setDimensions({width:c.vexWidth,height:c.vexHeight}),this.L("Rendering clef part MEI... "),MEI2VF.render_notation(b,a.getElement(),d,e,null,c),this.L("Done rendering clef part MEI")},alignCanvases:function(){$(this.maindiv).find(".main-canvas-div").position({my:"left top",at:"right top",of:$(this.maindiv).find(".clef-canvas-div"),collision:"none"})},alignSidebar:function(){$(this.maindiv).find(".sidebar").position({my:"left top",at:"right top",of:$(this.maindiv).find(".meiview-canvas-container"),collision:"none"})},resizeElements:function(){var a=(this.viewer,this.maindiv),b=$(a).width(),c=$(a).find(".main-canvas-div").height();canvas_container_width=b*(1-this.options.sidebar_ratio),"none"===$(a).find(".sidebar").css("display")&&(canvas_container_width=b-18);var d=c,e=b-canvas_container_width,f=c,g=$(a).find(".clef-canvas-div").width(),h=canvas_container_width-g+18,i=this.paginationOn()?$(a).find(".pagination-div").height():0,j=this.critRepOn()?$(a).find(".critrep-div").height():0,k=c+2*i+j;$(a).find(".clef-canvas-div").css("height",c),$(a).find(".view").css("width",b),$(a).find(".main-area").css("width",b),$(a).find(".main-area").css("height",k),$(a).find(".meiview-canvas-container").css("width",canvas_container_width),$(a).find(".meiview-canvas-container").css("height",d),$(a).find(".sidebar").css("width",e),$(a).find(".sidebar").css("height",f),$(a).find(".main-canvas-div").css("width",h),this.alignCanvases(),this.alignSidebar(),$(a).find("#accordion").accordion("refresh")},renderClefPart:function(a,b){b=b||{},b.scale=b.scale||1,b.vexWidth=b.vexWidth||$(this.canvasClef).attr("width"),b.vexHeight=b.vexHeight||$(this.canvasClef).attr("height");var c=(this.renderClefMei(this.fabrCanvasClef,a,b),new Image,MEI2VF.rendered_measures[1]),d=0;if(c){$(c).each(function(){if(this.getModifierXShift){var a=this.getModifierXShift();a>d&&(d=a)}})}console.log("max measure width: "+d.toString()),console.log("scale: "+b.scale.toString()),$(this.maindiv).find(".clef-canvas-div").css("width",d*b.scale),$(this.canvasClef).css("width",$(this.canvasClef).width()*b.scale),$(this.canvasClef).css("height",$(this.canvasClef).height()*b.scale)},displayVoiceNames:function(a,b){b.x="undefined"!=typeof b.x?b.x:10,b.y="undefined"!=typeof b.y?b.y:20;var c=this.viewer.voiceNames(a),d=this;$(this.maindiv).find(".voicename-div").hide();for(staff_n in c){var e=d.getVoiceNameDiv(staff_n),f=$(a).find("measure")[0];if(f){var g=$(f).attr("n")||"1",h=this.rendered_clefmeasures[g];if(h){var i=h[staff_n];if(i){var j=$(this.maindiv).find("canvas.clef-canvas").offset(),k=$(this.main_area).offset(),l=j.left-k.left,m=j.top-k.top;$(e).show(),$(e).css("top",(i.y+b.y+m)*d.scale),$(e).css("left",(i.x+b.x+l)*d.scale),$(e).find("span").html(c[staff_n]),$(e).find("span").css("font-size",(100*d.scale).toString()+"%")}}}}},getVoiceNameDiv:function(){var a=$(this.maindiv).find(".voicename-div.staff-n-"+staff_n);return 0===a.length?($(this.main_area).append('<div class="voicename-div staff-n-'+staff_n+'"><span></span></div>'),$(this.maindiv).find(".voicename-div.staff-n-"+staff_n)):a},onSelectorSelect:function(a){if(this.viewer.selectingState.ON){var b=this.viewer.selectingState.selectedVarXmlID;this.viewer.selectVariant(a.varXmlID),this.viewer.displayCurrentPage_TwoParts(),this.dlg&&this.dlg.bringToFront(),this.updateSidebar(this.viewer.selectingState.appID,b)}},displayDotForAPP:function(a){var b,c=this.viewer.MEI.ALTs[a].elem,d=$(c).parents("measure"),e=d.attr("n"),f=$(c).parents("staff");if(0===f.length){var g=$(c).find("[staff]");b=$(g).attr("staff")}else b=f.attr("n");var h=this.rendered_measures[e];if(h){var i=h[b];if(i){var j={appXmlID:a,measure_n:Number(e),measure_top:i.y,measure_left:i.x,measure_width:i.width,staff_n:Number(b)};return{circle:this.displayDotForMeasure(i),info:j}}}},fillCritReport:function(){var a=function(a){var b=$(a).find(".critrep-div table.critrep tbody");return 0===b.length?($(a).find(".critrep-div").append('<table class="critrep"><tbody><tr><th>Measure</th><th>Voice</th><th>Type</th><th>Source/Responsibility</th></tr></tbody></table>'),$(a).find(".critrep-div table.critrep tbody")):b},b=this;console.log("Critical Report:"),console.log(this.viewer.Report);var c=a(this.maindiv);for(h in this.viewer.Report){var d,e,f=this.viewer.Report[h];for(d=0,e=f.length;e>d;++d){var g=f[d],h=$(g.elem).closest("measure").attr("n"),i="",j="app"==g.tagname?"in ":"by ";for(altid in g.altitems){var k="";"rdg"==g.altitems[altid].tagname&&"variant"==$(g.altitems[altid].elem).attr("type")?k=g.altitems[altid].source:"corr"==g.altitems[altid].tagname&&(k=g.altitems[altid].resp),k&&(j+=i+k.replace(/#/g,"").replace(/ /g,", "),""==i&&(i=", "),$(b.maindiv).find(".critrep-div ul").append("<li>"+g.xmlID+"</li>"),$(c).append('<tr class="meiview-sidebar-item meiview-critrep-item"'+b.onClickSideBarMarkup(b,h,g.xmlID)+'><td class="critrep-field critrep-measureno">M'+h.toString()+'</td><td class="critrep-field critrep-voice">'+this.shortVoiceLabel(g.elem)+'</td><td class="critrep-field critrep-type">'+("app"==g.tagname?"Variant":"Emendation")+'</td><td class="critrep-field critrep-sources">'+j+"</td></tr>"))}}}0==$(c).find(".meiview-critrep-item").length&&this.hideCritRep()}});
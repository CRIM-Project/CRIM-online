{% extends "base.html" %}

{% load static %}

{% block title %}
  <title>CRIM | Citation tool</title>
{% endblock %}

{% block wrap %}
  <link rel="stylesheet" type="text/css" href="{% static 'node_modules/crim-citations/crim-citations.css' %}" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <h1>
    Citation tool
    {% if relationship_id %}
      <small><a href="/relationships/{{ relationship_id }}/">&lt;R{{ relationship_id }}&gt;</a></small>
    {% endif %}
  </h1>
  {% if request.user.is_authenticated and request.user.profile.person %}
    {% if relationship_id and not request.user.is_staff %}
      <p>
        You will not be able to submit changes to this relationship to the CRIM database, but you will be able to save your work locally.
      </p>
    {% endif %}
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--fixed-tabs">
      <header class="mdl-layout__header">
        <div class="mdl-layout__header-row crim_header" style="margin-top: 15px; margin-bottom: 15px;">
          <!-- Navigation. We hide it in small screens. -->
          <nav class="mdl-navigation">
            <button type="button" id="add_btn" class="btn btn-primary">
              Add scores
            </button>
            <button type="button" id="import_btn" class="btn btn-primary mdl-button mdl-js-button">
              Import analyses
            </button>
            <button type="button" id="export_btn" class="btn btn-info" style="display:none;">
              Export analyses
            </button>
            <button type="button" id="clear_btn" class="btn btn-danger">
              Clear analyses
            </button>
          </nav>
        </div>
      </header>
      <main class="mdl-layout__content" id="main-citations" data-pieces="/data/pieces/" data-relationship="{{ relationship_id }}">
        <!-- or data-scoreA, data-scoreB -->
        <section class="mdl-layout__tab-panel is-active" id="create_edit">
          <div class="page-content" id="create_edit">
            <div id="loader"><img src="{% static "/img/loading.gif" %}" width=128 /> Loading&hellip;</div>
            <div class="mdl-grid">
            </div>
          </div>
        </section>
      </main>
    </div>
    <div id="dialogs"></div>
  {% else %}
    <p>Please log in to use the CRIM citation tool.</p>
  {% endif %}

  <script src="{% static 'js/verovio/verovio-toolkit.js' %}"></script>
  <script src="{% static 'node_modules/crim-citations/crim-citations.js' %}"></script>
  <script src="{% static 'node_modules/dialog-polyfill/dialog-polyfill.js' %}"></script>
  <script type="text/javascript">
    // CSRF Token Protection lifted from Django documentation.
    var csrftoken = Cookies.set('csrftoken');
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    function sameOrigin(url) {
      // test that a given url is a same-origin URL
      // url could be relative or scheme relative or absolute
      var host = document.location.host; // host + port
      var protocol = document.location.protocol;
      var sr_origin = '//' + host;
      var origin = protocol + sr_origin;
      // Allow absolute or scheme relative URLs to same origin
      return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
        // or any other URL that isn't scheme relative or absolute i.e relative.
        !(/^(\/\/|http:|https:).*/.test(url));
    }
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
          // Send the token to same-origin, relative URLs only.
          // Send the token only if the method warrants CSRF protection
          // Using the CSRFToken value acquired earlier
          xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
      }
    });
  </script>

{% endblock %}
